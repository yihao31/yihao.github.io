<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<link rel="shortcut icon" href="#"/>
<title>手动人脸对齐</title>
</head>

<body>


<div id="container">

  <div id="header" style="background-color:black;">
  <h1 style="margin-bottom:0;color:white;text-align:center">手动人脸对齐</h1></div>
  
  <div id="input" style="float:left;">
    <div class="inputoutput">
      <input type="file" id="fileInput" name="file" />
    </div>
    <div class="inputoutput">
      <canvas id="canvasInput" width="320" height="400" style="border:1px solid #000000;"></canvas>
      <div class="caption">输入图像</div>
    </div>
  </div>
  <div id="output" style="float:left;">
    <div class="inputoutput">
      <input type="button" id="alignButton" value="手动对齐" />
      <div class="control"><button id="auto_alignButton" disabled>自动对齐</button></div>
      <!-- <input type="button" id="auto_alignButton" value="自动对齐" /> -->
    </div>
    <div class="inputoutput">
      <canvas id="canvasOutput" width="320" height="400" style="border:1px solid #000000;"></canvas>
      <div class="caption">对齐图像</div>
    </div>
  </div>

</div>



<script src="js/utils.js" type="text/javascript"></script>
<script src="js/opencv.js" type="text/javascript"></script>

<script type="text/javascript">
// added by haoyi for auto alignment
let auto_alignButton = document.getElementById('auto_alignButton');
let utils = new Utils('errorMessage');
// utils.addFileInputHandler('fileInput', 'canvasInput');
// utils.loadOpenCv(() => {
//       let eyeCascadeFile = 'haarcascade_eye.xml';
//       utils.createFileFromUrl(eyeCascadeFile, eyeCascadeFile, () => {
//           let faceCascadeFile = 'haarcascade_frontalface_default.xml';
//           utils.createFileFromUrl(faceCascadeFile, faceCascadeFile, () => {

  auto_alignButton.removeAttribute('disabled');
//           });
//       });
//   });


let eyeCascadeFile = 'haarcascade_eye.xml';
utils.createFileFromUrl(eyeCascadeFile, eyeCascadeFile, () => {
    let faceCascadeFile = 'haarcascade_frontalface_default.xml';
    utils.createFileFromUrl(faceCascadeFile, faceCascadeFile, () => {
    let mouthCascadeFile = 'mouth.xml';
    utils.createFileFromUrl(mouthCascadeFile, mouthCascadeFile, () => {
    auto_alignButton.removeAttribute('disabled');
    });
  });
});

auto_alignButton.addEventListener('click', () => {
    // utils.executeCode('codeSnippet');
  // let src = cv.imread('canvasInput');
	let gray = new cv.Mat();
	cv.cvtColor(src, gray, cv.COLOR_RGBA2GRAY, 0);
	let faces = new cv.RectVector();
	let eyes = new cv.RectVector();
	let faceCascade = new cv.CascadeClassifier();
	let eyeCascade = new cv.CascadeClassifier();
	let mouthCascade = new cv.CascadeClassifier();
	// load pre-trained classifiers
	faceCascade.load('haarcascade_frontalface_default.xml');
	eyeCascade.load('haarcascade_eye.xml');
	mouthCascade.load('mouth.xml');
	// detect faces
	let msize = new cv.Size(0, 0);
  faceCascade.detectMultiScale(gray, faces, 1.1, 3, 0, msize, msize);
  // src_points = [0, 0, 0, 0, 0, 0];
	for (let i = 0; i < faces.size(); ++i) {
	    let roiGray = gray.roi(faces.get(i));
	    let point1 = new cv.Point(faces.get(i).x, faces.get(i).y);
	    let point2 = new cv.Point(faces.get(i).x + faces.get(i).width,
	                              faces.get(i).y + faces.get(i).height);
	    cv.rectangle(gray, point1, point2, [255, 0, 0, 255]);
	    // detect eyes in face ROI
	    eyeCascade.detectMultiScale(roiGray, eyes);
      
      let eye_point1 = new cv.Point(eyes.get(0).x + eyes.get(0).width*0.5,
                                eyes.get(0).y + eyes.get(0).height*0.5);
      let eye_point2 = new cv.Point(eyes.get(1).x + eyes.get(1).width*0.5,
                                eyes.get(1).y + eyes.get(1).height*0.5);
      if (eye_point1.x>eye_point2.x){
        src_points[0] = eye_point2.x+faces.get(i).x;
        src_points[1] = eye_point2.y+faces.get(i).y;
        src_points[2] = eye_point1.x+faces.get(i).x;
        src_points[3] = eye_point1.y+faces.get(i).y;
      }
      if (eye_point2.x>eye_point1.x) 
      {
        src_points[0] = eye_point1.x+faces.get(i).x;
        src_points[1] = eye_point1.y+faces.get(i).y;
        src_points[2] = eye_point2.x+faces.get(i).x;
        src_points[3] = eye_point2.y+faces.get(i).y;
      }
      cv.circle(roiGray, eye_point1, 4, [255, 0, 0, 255]);
      cv.circle(roiGray, eye_point2, 4, [255, 0, 0, 255]);
      roiGray.delete();
    }
    
  // detect mouth in face ROI
  // let face_down = new cv.RectVector();
  // let mouth = new cv.RectVector();
  // face_down.x = faces.get(i).x;
  // face_down.y = faces.get(i).y+faces.get(i).height*0.5;
  // face_down.height = faces.get(i).height*0.5;
  // face_down.width = faces.get(i).width;
  // let roiGray = gray.roi(face_down);
  // mouthCascade.detectMultiScale(roiGray, mouth);
  // let point1_m = new cv.Point(face_down.x, face_down.y);
  // let point2_m = new cv.Point(face_down.x + face_down.width,
  //                         face_down.y + face_down.height);
  // // cv.rectangle(src, point1_m, point2_m, [0, 0, 0, 255]);
  // let middle_point = new cv.Point(0,0); 
  // for (let j = 0; j < mouth.size(); ++j) {
  //   let current_middle_point = new cv.Point(mouth.get(j).x + mouth.get(j).width*0.5,
  //                                 mouth.get(j).y + mouth.get(i).height*0.5);
  //   if (middle_point.x!=0){
  //     middle_point.x = (middle_point.x+current_middle_point.x)*0.5;
  //     middle_point.y = (middle_point.y+current_middle_point.y)*0.5;
  //   }
  //   else
  //   {
  //     middle_point = current_middle_point
  //   }
  // }      
  // src_points[4] = middle_point.x+face_down.x;
  // src_points[5] = middle_point.y+face_down.y;
  // cv.circle(roiGray, middle_point,4 ,[0, 255, 255, 255]);
  cv.imshow('canvasInput', gray);
  dst = new cv.Mat();
  // dst_points = [120, 196, 195, 196, 160, 300];
  // 三点对齐
  // let srcTri = cv.matFromArray(3, 1, cv.CV_32FC2, src_points);
  // let dstTri = cv.matFromArray(3, 1, cv.CV_32FC2, dst_points);
  // let dsize = new cv.Size(320, 400);
  // let M = cv.getAffineTransform(srcTri, dstTri);
  // cv.warpAffine(src, dst, M, dsize, cv.INTER_LINEAR, cv.BORDER_CONSTANT, new cv.Scalar());
  //两点对齐
  let desiredSize = [320, 400];
  let rightEyePoint = [src_points[0],src_points[1]]
  let leftEyePoint = [src_points[2],src_points[3]]
  let desiredLeftEye = [0.375, 0.5];
  let desiredRightEye = [0.625, 0.5];
  let dY = rightEyePoint[1] - leftEyePoint[1];
	let dX = rightEyePoint[0] - leftEyePoint[0];
  let angle = Math.atan(dY/dX) * 180 / Math.PI;
  // console.log(angle);
  let dist = Math.sqrt((dX ** 2) + (dY ** 2))
  // console.log(dist);
  let desiredDist = (desiredRightEye[0] - desiredLeftEye[0]) * desiredSize[0];
  // console.log(desiredDist);
  let scale = desiredDist / dist;
  // console.log(scale);
  let twoEyeCenter = new cv.Point((leftEyePoint[0] + rightEyePoint[0]) / 2, (leftEyePoint[1] + rightEyePoint[1]) / 2);
  // console.log(twoEyeCenter);
  let M_R = cv.getRotationMatrix2D(twoEyeCenter, angle, scale);
  let tX = desiredSize[0] * 0.5 - twoEyeCenter.x
	let tY = desiredSize[1] * desiredLeftEye[1] - twoEyeCenter.y
  let M_T = cv.matFromArray(2, 3, cv.CV_64FC1, [1, 0, tX, 0, 1, tY]);
  cv.warpAffine(src, dst, M_R, new cv.Size(src.cols, src.rows), cv.INTER_LINEAR, cv.BORDER_CONSTANT, new cv.Scalar());
  cv.warpAffine(dst, dst, M_T, new cv.Size(320, 400), cv.INTER_LINEAR, cv.BORDER_CONSTANT, new cv.Scalar());
  cv.imshow('canvasOutput', dst);
  dst.delete();
  gray.delete(); faceCascade.delete();
  eyeCascade.delete(); faces.delete(); eyes.delete(); 
});


// added by mrzhu for handed alignment
var img = new Image()
let canvas = document.getElementById('canvasInput');
let ctx = canvas.getContext('2d');
let inputElement = document.getElementById('fileInput');
inputElement.addEventListener('change', (e) => {
  img.src = URL.createObjectURL(e.target.files[0]);
}, false);
canvas.addEventListener("click", function(event) {
    getMouseClickPos(canvas, event);
});
img.onload = function() {
  src = cv.imread(img);
  // ctx.drawImage(img,0,0)
  cv.imshow('canvasInput', src);
  dst = new cv.Mat();
  // alert("请使用鼠标左键依次点击人脸图片的左眼中心、右眼中心、嘴巴中心然后点击手动对齐按钮进行人脸对齐");
};

// src_points = [0, 0, 0, 0, 0, 0];
// dst_points = [120, 196, 195, 196, 160, 300];

var i = 0;
src_points = [0, 0, 0, 0, 0, 0];
dst_points = [120, 196, 195, 196, 160, 300];
function getMouseClickPos(canvas, event) {
  var rect = canvas.getBoundingClientRect();
  var x = event.clientX - rect.left * (canvas.width / rect.width);
  var y = event.clientY - rect.top * (canvas.height / rect.height);
  ctx.fillStyle="#0000FF";
  ctx.beginPath();
  ctx.arc(x,y,3,0,Math.PI*2);
  ctx.fill();
  // alert("点击坐标" + "X:" + x + "Y:" + y);
  i++;
  switch (i) {
    case 1:
      src_points[0] = x;
      src_points[1] = y;
      break;
    case 2:
      src_points[2] = x;
      src_points[3] = y;
      break;
    case 3:
      src_points[4] = x;
      src_points[5] = y;
      i = 0;
      break;
    default:
  }
}

let align_button = document.getElementById("alignButton");
align_button.onclick = function(){
  dst = new cv.Mat();
  let srcTri = cv.matFromArray(3, 1, cv.CV_32FC2, src_points);
  let dstTri = cv.matFromArray(3, 1, cv.CV_32FC2, dst_points);
  let dsize = new cv.Size(320, 400);
  let M = cv.getAffineTransform(srcTri, dstTri);
  cv.warpAffine(src, dst, M, dsize, cv.INTER_LINEAR, cv.BORDER_CONSTANT, new cv.Scalar());
  cv.imshow('canvasOutput', dst);
  // src.delete()
  // dst.delete()
  // M.delete()
  // srcTri.delete()
  // dstTri.delete()
}



</script>

</body>
</html>